name: PR Preview Build

on:
  pull_request:
    branches:
      - src
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

# Prevent concurrent builds for same PR
concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build-preview:
    name: Build Preview
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install MkDocs
        run: pip install mkdocs

      - name: Build site
        run: mkdocs build

      - name: Create preview archive
        run: |
          cd site
          zip -r ../preview-site.zip .
          cd ..

      - name: Upload preview as artifact
        uses: actions/upload-artifact@v4
        with:
          name: preview-pr-${{ github.event.pull_request.number }}
          path: preview-site.zip
          retention-days: 30

      - name: Comment on PR
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ðŸ“¦ Preview Build Ready

            Your preview has been built successfully!

            **Download preview**: Click on "Actions" tab â†’ Select this workflow run â†’ Download the `preview-pr-${{ github.event.pull_request.number }}` artifact

            To view the preview:
            1. Download and extract the zip file
            2. Open `index.html` in your browser

            ---
            *Built from commit ${{ github.event.pull_request.head.sha }}*
